name: Auto Publish SDK

on:
  push:
    branches: [main, prod]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  INFO_COLOR: "\033[0;32m"    # Green
  ERROR_COLOR: "\033[0;31m"   # Red
  RESET_COLOR: "\033[0m"      # Reset to default

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:

      - name: Setup logging functions
        run: |
          cat >> ~/.bashrc << 'EOF'
          log_info() { echo "${INFO_COLOR}INFO:${RESET_COLOR} $1"; }
          log_error() { echo "${ERROR_COLOR}ERROR:${RESET_COLOR} $1"; exit 1; }
          EOF
          echo "BASH_ENV=~/.bashrc" >> $GITHUB_ENV

      - name: Checkout agents-sdk repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: prod

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build package
        run: yarn build

      - name: Determine version and tag
        id: version
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            # For main branch - staging versions with run number
            BASE_VERSION=$(jq -r '.version' package.json)
            log_info "Base version: $BASE_VERSION"

            if [ "$BASE_VERSION" = "null" ]; then
              log_error "Could not read version from package.json"
            fi

            CLEAN_VERSION=$(echo "$BASE_VERSION" | sed 's/-.*$//')
            STAGING_VERSION="${CLEAN_VERSION}-staging.${{ github.run_number }}"

            log_info "Clean version: $CLEAN_VERSION"
            log_info "Staging version: $STAGING_VERSION"

            echo "version=$STAGING_VERSION" >> $GITHUB_OUTPUT
            echo "tag=staging" >> $GITHUB_OUTPUT
            echo "description=Staging release from main branch" >> $GITHUB_OUTPUT
            echo "should_sync=false" >> $GITHUB_OUTPUT
          else
            # For prod branch - production versions
            log_info "Determining production version"

            # Use npm version command (official npm way to bump versions)
            NEW_VERSION=$(npm version patch --no-git-tag-version --silent)
            log_info "New version: $NEW_VERSION"

            NEW_VERSION=${NEW_VERSION#v}  # Remove 'v' prefix if present
            log_info "New version without 'v' prefix: $NEW_VERSION"

            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "description=Production release" >> $GITHUB_OUTPUT
            echo "should_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version
        run: |
          log_info "Updating package.json version"
          jq --arg version "${{ steps.version.outputs.version }}" '.version = $version' package.json > package.json.tmp

          if ! jq empty package.json.tmp 4>/dev/null; then
            rm -f package.json.tmp
            log_error "Generated invalid JSON"
          fi

          mv package.json.tmp package.json
          log_info "Updated package.json version to: ${{ steps.version.outputs.version }}"

      - name: Publish to NPM
        if: ${{ false }} # Disable publishing to NPM for testing purposes
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            log_info "ðŸ” DRY RUN MODE: Would publish version ${{ steps.version.outputs.version }} with tag ${{ steps.version.outputs.tag }}"
            log_info "ðŸ“¦ Package would be published to: https://www.npmjs.com/package/@d-id/client-sdk/v/${{ steps.version.outputs.version }}"
            log_info "ðŸ·ï¸  NPM tag would be: ${{ steps.version.outputs.tag }}"
            log_info "âœ… Dry run completed successfully - no actual publishing occurred"
          else
            log_info "ðŸš€ Publishing version ${{ steps.version.outputs.version }} with tag ${{ steps.version.outputs.tag }}"
            npm publish --access public --tag ${{ steps.version.outputs.tag }}
            log_info "âœ… Successfully published to NPM"
          fi

      - name: Create Git tag for production
        #if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        run: |
          log_info "Creating Git tag for production"

          log_info "Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          log_info "Creating Git tag"
          git tag "v${{ steps.version.outputs.version }}"

          log_info "Pushing Git tag to origin"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Commit version bump (prod only)
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        run: |
          log_info "Committing version bump"

          log_info "Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json

          log_info "Committing version bump without triggering the CICD pipeline"
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]" || log_info "No changes to commit"
          git push origin prod

      - name: Sync version back to main (prod only)
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        run: |
          log_info "Fetching latest main"
          git fetch origin main
          git checkout main
          git pull origin main

          log_info "Updating package.json version"
          jq --arg version "${{ steps.version.outputs.version }}" '.version = $version' package.json > package.json.tmp

          if ! jq empty package.json.tmp 4>/dev/null; then
            rm -f package.json.tmp
            log_error "Generated invalid JSON"
          fi

          mv package.json.tmp package.json

          if git diff --quiet package.json; then
            log_info "No version changes needed"
          else
            log_info "Configuring Git user"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            log_info "Adding and committing package.json to main branch without triggering the CICD pipeline"
            git add package.json
            git commit -m "chore: sync version ${{ steps.version.outputs.version }} from prod [skip ci]"

            log_info "Pushing package.json to main branch"
            git push origin main
          fi

      - name: Create GitHub Release (prod only)
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Release v${{ steps.version.outputs.version }}

            **Published to NPM:** [@d-id/client-sdk@${{ steps.version.outputs.version }}](https://www.npmjs.com/package/@d-id/client-sdk/v/${{ steps.version.outputs.version }})

            ### Installation
            ```bash
            npm install @d-id/client-sdk@${{ steps.version.outputs.version }}
            ```

            ${{ steps.version.outputs.description }}

      - name: Checkout agents-ui repository
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        uses: actions/checkout@v6
        with:
          repository: de-id/agents-ui
          token: ${{ secrets.DEVOPS_TOKEN }}
          path: agents-ui

      - name: Update SDK version and create PR
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        working-directory: agents-ui
        env:
          GH_TOKEN: ${{ secrets.DEVOPS_TOKEN }}
        run: |
          log_info "Updating SDK version in agents-ui"

          jq --arg version "${{ steps.version.outputs.version }}" '.dependencies."@d-id/client-sdk" = $version' package.json > package.json.tmp
          mv package.json.tmp package.json

          if git diff --quiet package.json; then
            log_info "No version changes needed in agents-ui"
            exit 0
          fi

          log_info "Creating new branch"
          git checkout -b "chore/bump-sdk-version-${{ steps.version.outputs.version }}"

          log_info "Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          log_info "Adding and committing package.json"
          git add package.json
          git commit -m "chore: bump @d-id/client-sdk to v${{ steps.version.outputs.version }}"

          log_info "Publishing branch to origin"
          git push origin "chore/bump-sdk-version-${{ steps.version.outputs.version }}"

          log_info "Creating PR on agents-ui repository"
          gh pr create \
            --repo de-id/agents-ui \
            --title "chore: bump @d-id/client-sdk to v${{ steps.version.outputs.version }}" \
            --body "## SDK Version Update

          This PR updates the @d-id/client-sdk dependency to version ${{ steps.version.outputs.version }}.

          ### Changes
          - Updated @d-id/client-sdk from previous version to v${{ steps.version.outputs.version }}

          ### Related
          - SDK Release: [v${{ steps.version.outputs.version }}](https://github.com/d-id/agents-sdk/releases/tag/v${{ steps.version.outputs.version }})
          - NPM Package: [@d-id/client-sdk@${{ steps.version.outputs.version }}](https://www.npmjs.com/package/@d-id/client-sdk/v/${{ steps.version.outputs.version }})

          ### Next Steps
          - [ ] Review the changes
          - [ ] Run tests to ensure compatibility
          - [ ] Merge when ready" \
            --base main \
            --head "chore/bump-sdk-version-${{ steps.version.outputs.version }}" \
            --label "dependencies"
