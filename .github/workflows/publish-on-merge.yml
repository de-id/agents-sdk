name: Auto Publish SDK

on:
  push:
    branches: [main, prod]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run in dry-run mode (no actual publishing)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        uses: actions/create-github-app-token@v2
        id: generate_token
        with:
          app-id: ${{ secrets.AGENTS_SDK_AUTOMATIONS_APP_ID }}
          private-key: ${{ secrets.AGENTS_SDK_AUTOMATIONS_PRIVATE_KEY }}
          owner: de-id
          repositories: |
            agents-sdk
            agents-ui

      - name: Checkout agents-sdk repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.generate_token.outputs.token }}
          fetch-depth: 0

      - name: Setup logger
        run: |
          sudo cp .github/scripts/logger.sh /usr/local/bin/logger
          sudo chmod +x /usr/local/bin/logger

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"
          cache: "yarn"

      - name: Install dependencies
        run: |
          logger -l info -m "Installing dependencies"
          yarn install --frozen-lockfile \
            || logger -l error -m "Failed to install dependencies"

      - name: Build package
        run: |
          logger -l info -m "Building package"
          yarn build \
            || logger -l error -m "Failed to build package"

      - name: Determine version and tag
        id: version
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            # For main branch - staging versions with run number
            BASE_VERSION=$(jq -r '.version' package.json)
            logger -l info -m "Base version: $BASE_VERSION"

            if [ "$BASE_VERSION" = "null" ]; then
              logger -l error -m "Could not read version from package.json"
            fi

            CLEAN_VERSION=$(echo "$BASE_VERSION" | sed 's/-.*$//')
            STAGING_VERSION="${CLEAN_VERSION}-staging.${{ github.run_number }}"

            logger -l info -m "Clean version: $CLEAN_VERSION"
            logger -l info -m "Staging version: $STAGING_VERSION"

            echo "version=$STAGING_VERSION" >> $GITHUB_OUTPUT
            echo "tag=staging" >> $GITHUB_OUTPUT
            echo "description=Staging release from main branch" >> $GITHUB_OUTPUT
            echo "should_sync=false" >> $GITHUB_OUTPUT
          else
            # For prod branch - production versions
            logger -l info -m "Determining production version"

            # Use npm version command (official npm way to bump versions)
            NEW_VERSION=$(npm version patch --no-git-tag-version --silent)
            logger -l info -m "New version: $NEW_VERSION"

            NEW_VERSION=${NEW_VERSION#v}  # Remove 'v' prefix if present
            logger -l info -m "New version without 'v' prefix: $NEW_VERSION"

            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "description=Production release" >> $GITHUB_OUTPUT
            echo "should_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version
        run: |
          logger -l info -m "Updating package.json version"
          jq --arg version "${{ steps.version.outputs.version }}" '.version = $version' package.json > package.json.tmp

          if ! jq empty package.json.tmp 4>/dev/null; then
            rm -f package.json.tmp
            logger -l error -m "Generated invalid JSON"
          fi

          mv package.json.tmp package.json
          logger -l info -m "Updated package.json version to: ${{ steps.version.outputs.version }}"

      - name: Publish to NPM
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_PACKAGE_UPLOAD_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            logger -l info -m "ðŸ” DRY RUN MODE: Would publish version ${{ steps.version.outputs.version }} with tag ${{ steps.version.outputs.tag }}"
            logger -l info -m "ðŸ“¦ Package would be published to: https://www.npmjs.com/package/@d-id/client-sdk/v/${{ steps.version.outputs.version }}"
            logger -l info -m "ðŸ·ï¸  NPM tag would be: ${{ steps.version.outputs.tag }}"
            logger -l info -m "âœ… Dry run completed successfully - no actual publishing occurred"
          else
            logger -l info -m "ðŸš€ Publishing version ${{ steps.version.outputs.version }} with tag ${{ steps.version.outputs.tag }}"
            npm publish --access public --tag ${{ steps.version.outputs.tag }}
            logger -l info -m "âœ… Successfully published to NPM"
          fi

      - name: Create Git tag for production
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        run: |
          logger -l info -m "Creating Git tag for production"

          logger -l info -m "Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          logger -l info -m "Creating Git tag"
          git tag "v${{ steps.version.outputs.version }}"

          logger -l info -m "Pushing Git tag to origin"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Commit version bump (prod only)
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        run: |
          logger -l info -m "Committing version bump"

          logger -l info -m "Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json

          logger -l info -m "Committing version bump without triggering the CICD pipeline"
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]" || logger -l info -m "No changes to commit"

          logger -l info -m "Force push into prod branch"
          git push origin prod --force \
            || logger -l error -m "Failed to update package.json file in prod branch"

      - name: Sync version back to main (prod only)
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        run: |
          logger -l info -m "Fetching latest main"
          git fetch origin main
          git checkout main
          git pull origin main

          logger -l info -m "Updating package.json version"
          jq --arg version "${{ steps.version.outputs.version }}" '.version = $version' package.json > package.json.tmp

          if ! jq empty package.json.tmp 4>/dev/null; then
            rm -f package.json.tmp
            logger -l error -m "Generated invalid JSON"
          fi

          mv package.json.tmp package.json

          if git diff --quiet package.json; then
            logger -l info -m "No version changes needed"
          else
            logger -l info -m "Configuring Git user"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            logger -l info -m "Adding and committing package.json to main branch without triggering the CICD pipeline"
            git add package.json
            git commit -m "chore: sync version ${{ steps.version.outputs.version }} from prod [skip ci]"

            logger -l info -m "Pushing package.json to main branch"
            git push origin main
          fi

      - name: Create GitHub Release (prod only)
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Release v${{ steps.version.outputs.version }}

            **Published to NPM:** [@d-id/client-sdk@${{ steps.version.outputs.version }}](https://www.npmjs.com/package/@d-id/client-sdk/v/${{ steps.version.outputs.version }})

            ### Installation
            ```bash
            npm install @d-id/client-sdk@${{ steps.version.outputs.version }}
            ```

            ${{ steps.version.outputs.description }}

      - name: Checkout agents-ui repository
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        uses: actions/checkout@v6
        with:
          repository: de-id/agents-ui
          token: ${{ steps.generate_token.outputs.token }}
          path: agents-ui

      - name: Update SDK version and create PR
        if: github.ref_name == 'prod' && github.event.inputs.dry_run != 'true'
        working-directory: agents-ui
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          logger -l info -m "Updating SDK version in agents-ui"

          jq --arg version "${{ steps.version.outputs.version }}" '.dependencies."@d-id/client-sdk" = $version' package.json > package.json.tmp
          mv package.json.tmp package.json

          if git diff --quiet package.json; then
            logger -l info -m "No version changes needed in agents-ui"
            exit 0
          fi

          logger -l info -m "Installing dependencies to update yarn.lock"
          yarn install

          logger -l info -m "Creating new branch"
          git checkout -b "chore/bump-sdk-version-${{ steps.version.outputs.version }}"

          logger -l info -m "Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          logger -l info -m "Adding and committing package.json and yarn.lock"
          git add package.json yarn.lock
          git commit -m "chore: bump @d-id/client-sdk to v${{ steps.version.outputs.version }}"

          logger -l info -m "Publishing branch to origin"
          git push origin "chore/bump-sdk-version-${{ steps.version.outputs.version }}"

          logger -l info -m "Creating PR on agents-ui repository"
          gh pr create \
            --repo de-id/agents-ui \
            --title "chore: bump @d-id/client-sdk to v${{ steps.version.outputs.version }}" \
            --body "## SDK Version Update

          This PR updates the @d-id/client-sdk dependency to version ${{ steps.version.outputs.version }}.

          ### Changes
          - Updated @d-id/client-sdk from previous version to v${{ steps.version.outputs.version }}

          ### Related
          - SDK Release: [v${{ steps.version.outputs.version }}](https://github.com/d-id/agents-sdk/releases/tag/v${{ steps.version.outputs.version }})
          - NPM Package: [@d-id/client-sdk@${{ steps.version.outputs.version }}](https://www.npmjs.com/package/@d-id/client-sdk/v/${{ steps.version.outputs.version }})

          ### Next Steps
          - [ ] Review the changes
          - [ ] Run tests to ensure compatibility
          - [ ] Merge when ready" \
            --base main \
            --head "chore/bump-sdk-version-${{ steps.version.outputs.version }}" \
            --label "dependencies"
